<div id="editor" style="border:1px solid #ccc; border-radius:8px; overflow:hidden;"></div>
<iframe id="preview" sandbox style="width:100%; min-height:340px; margin-top:12px; border:1px solid #ccc; border-radius:8px;"></iframe>

<script type="module">
  import { EditorView, basicSetup } from "https://esm.sh/codemirror@6.0.2"; /* package codemirror v6 */ /*  [oai_citation:2â€¡npm](https://npmjs.com/package/codemirror?utm_source=chatgpt.com) */
  import { html } from "https://esm.sh/@codemirror/lang-html@6.4.11";       /* coloration HTML */      /*  [oai_citation:3â€¡GitHub](https://github.com/codemirror/lang-html?utm_source=chatgpt.com) */

  const root = document.getElementById("editor");
  const frame = document.getElementById("preview");

  const EXAMPLE = `<!-- Modifie-moi ðŸ™‚ -->
<h1>Hello ðŸ‘‹</h1>
<p>Un paragraphe <strong>en gras</strong> et <em>en italique</em>.</p>
<ul><li>Item 1</li><li>Item 2</li></ul>
<style>
  body{font-family:Arial; padding:16px;}
  h1{color:teal;}
</style>`;

  function wrapIfNeeded(input) {
    const s = input.trim();
    const looksLikeFullPage = /<html[\s>]|<body[\s>]|<!doctype/i.test(s);
    if (looksLikeFullPage) return s;
    return `<!doctype html><html><head><meta charset="utf-8"></head><body>${s}</body></html>`;
  }

  function render(view) {
    const code = view.state.doc.toString();
    frame.srcdoc = wrapIfNeeded(code);
    localStorage.setItem("mini_html_editor_code", code);
  }

  try {
    if (!root) throw new Error("Ã‰lÃ©ment #editor introuvable");

    const startDoc = localStorage.getItem("mini_html_editor_code") ?? EXAMPLE;

    let t = null;
    const view = new EditorView({
      parent: root,
      doc: startDoc,
      extensions: [
        basicSetup,
        html(), // support + coloration HTML  [oai_citation:4â€¡GitHub](https://github.com/codemirror/lang-html?utm_source=chatgpt.com)
        EditorView.updateListener.of((u) => {
          if (!u.docChanged) return;
          clearTimeout(t);
          t = setTimeout(() => render(view), 120);
        }),
        EditorView.theme({ "&": { height: "340px" } })
      ],
    });

    render(view);
  } catch (e) {
    // Fallback (au moins tu vois une zone de saisie)
    root.innerHTML = `<textarea style="width:100%;height:340px;padding:12px;font-family:monospace;">${EXAMPLE}</textarea>`;
    console.error(e);
  }
</script>
